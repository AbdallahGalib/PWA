import{s as se,n as H,o as le,d as ie,e as ae,r as ce}from"../chunks/scheduler.Bvac2VuE.js";import{S as ue,i as fe,e as k,s as q,b as Z,m as de,c as w,g,h as R,d as A,f as B,n as $,o as y,k as _,j as z,l as te,p as Y}from"../chunks/index.Ji3sbTeO.js";import{L as N,e as ne,u as he,d as pe}from"../chunks/leaflet.draw.BT58w--h.js";const ge=typeof window<"u"?window:typeof globalThis<"u"?globalThis:global,{Map:me}=ge;function oe(l,e,t){const n=l.slice();return n[31]=e[t][0],n[32]=e[t][1],n}function _e(l){let e,t="Start Monitoring",n,i;return{c(){e=k("button"),e.textContent=t,this.h()},l(s){e=w(s,"BUTTON",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-8rrxot"&&(e.textContent=t),this.h()},h(){y(e,"class","control-button start svelte-ov1eb9")},m(s,o){z(s,e,o),n||(i=Y(e,"click",l[6]),n=!0)},p:H,d(s){s&&g(e),n=!1,i()}}}function ve(l){let e,t="Stop Monitoring",n,i;return{c(){e=k("button"),e.textContent=t,this.h()},l(s){e=w(s,"BUTTON",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-149dva3"&&(e.textContent=t),this.h()},h(){y(e,"class","control-button stop svelte-ov1eb9")},m(s,o){z(s,e,o),n||(i=Y(e,"click",l[7]),n=!0)},p:H,d(s){s&&g(e),n=!1,i()}}}function ye(l){let e,t=[],n=new me,i=ne(Array.from(l[1]));const s=o=>o[32].id;for(let o=0;o<i.length;o+=1){let r=oe(l,i,o),a=s(r);n.set(a,t[o]=re(a,r))}return{c(){e=k("ul");for(let o=0;o<t.length;o+=1)t[o].c();this.h()},l(o){e=w(o,"UL",{class:!0});var r=A(e);for(let a=0;a<t.length;a+=1)t[a].l(r);r.forEach(g),this.h()},h(){y(e,"class","svelte-ov1eb9")},m(o,r){z(o,e,r);for(let a=0;a<t.length;a+=1)t[a]&&t[a].m(e,null)},p(o,r){r[0]&270&&(i=ne(Array.from(o[1])),t=he(t,r,s,1,o,i,n,e,pe,re,null,oe))},d(o){o&&g(e);for(let r=0;r<t.length;r+=1)t[r].d()}}}function be(l){let e,t="No geofences created yet. Use the drawing tools to create one.";return{c(){e=k("p"),e.textContent=t,this.h()},l(n){e=w(n,"P",{class:!0,"data-svelte-h":!0}),$(e)!=="svelte-cq9e1g"&&(e.textContent=t),this.h()},h(){y(e,"class","no-geofences svelte-ov1eb9")},m(n,i){z(n,e,i)},p:H,d(n){n&&g(e)}}}function ke(l){let e,t=l[31]+"",n,i,s;function o(){return l[12](l[32],l[31])}return{c(){e=k("button"),n=Z(t),this.h()},l(r){e=w(r,"BUTTON",{class:!0});var a=A(e);n=B(a,t),a.forEach(g),this.h()},h(){y(e,"class","geofence-name-button svelte-ov1eb9")},m(r,a){z(r,e,a),_(e,n),i||(s=Y(e,"click",o),i=!0)},p(r,a){l=r,a[0]&2&&t!==(t=l[31]+"")&&te(n,t)},d(r){r&&g(e),i=!1,s()}}}function we(l){let e,t,n;function i(...s){return l[11](l[31],...s)}return{c(){e=k("input"),this.h()},l(s){e=w(s,"INPUT",{type:!0,class:!0}),this.h()},h(){y(e,"type","text"),y(e,"class","rename-input svelte-ov1eb9"),e.value=l[3]},m(s,o){z(s,e,o),t||(n=[Y(e,"input",l[10]),Y(e,"keydown",i)],t=!0)},p(s,o){l=s,o[0]&8&&e.value!==l[3]&&(e.value=l[3])},d(s){s&&g(e),t=!1,ce(n)}}}function re(l,e){let t,n,i,s,o=e[32].type+"",r,a,E;function v(h,f){return h[2]===h[32].id?we:ke}let b=v(e),d=b(e);return{key:l,first:null,c(){t=k("li"),d.c(),n=q(),i=k("span"),s=Z("("),r=Z(o),a=Z(")"),E=q(),this.h()},l(h){t=w(h,"LI",{class:!0});var f=A(t);d.l(f),n=R(f),i=w(f,"SPAN",{class:!0});var T=A(i);s=B(T,"("),r=B(T,o),a=B(T,")"),T.forEach(g),E=R(f),f.forEach(g),this.h()},h(){y(i,"class","geofence-type svelte-ov1eb9"),y(t,"class","geofence-item svelte-ov1eb9"),this.first=t},m(h,f){z(h,t,f),d.m(t,null),_(t,n),_(t,i),_(i,s),_(i,r),_(i,a),_(t,E)},p(h,f){e=h,b===(b=v(e))&&d?d.p(e,f):(d.d(1),d=b(e),d&&(d.c(),d.m(t,n))),f[0]&2&&o!==(o=e[32].type+"")&&te(r,o)},d(h){h&&g(t),d.d()}}}function Me(l){let e,t,n,i,s,o,r,a,E,v,b,d,h,f,T="Geofences",S;function U(p,I){return p[5]?ve:_e}let D=U(l),P=D(l);function F(p,I){return p[1].size===0?be:ye}let O=F(l),L=O(l);return{c(){e=k("meta"),t=q(),n=k("main"),i=k("div"),s=k("div"),o=k("div"),r=k("p"),a=Z(l[4]),E=q(),P.c(),v=q(),b=k("div"),d=q(),h=k("div"),f=k("h3"),f.textContent=T,S=q(),L.c(),this.h()},l(p){const I=de("svelte-1ps6v8r",document.head);e=w(I,"META",{name:!0,content:!0}),I.forEach(g),t=R(p),n=w(p,"MAIN",{});var K=A(n);i=w(K,"DIV",{class:!0});var J=A(i);s=w(J,"DIV",{class:!0});var V=A(s);o=w(V,"DIV",{class:!0});var j=A(o);r=w(j,"P",{class:!0});var Q=A(r);a=B(Q,l[4]),Q.forEach(g),E=R(j),P.l(j),j.forEach(g),v=R(V),b=w(V,"DIV",{class:!0}),A(b).forEach(g),d=R(V),h=w(V,"DIV",{class:!0});var W=A(h);f=w(W,"H3",{class:!0,"data-svelte-h":!0}),$(f)!=="svelte-pnijaz"&&(f.textContent=T),S=R(W),L.l(W),W.forEach(g),V.forEach(g),J.forEach(g),K.forEach(g),this.h()},h(){document.title="Geofencing PWA",y(e,"name","description"),y(e,"content","A Progressive Web App for geofencing"),y(r,"class","status-text svelte-ov1eb9"),y(o,"class","status-bar svelte-ov1eb9"),y(b,"class","map-container svelte-ov1eb9"),y(f,"class","svelte-ov1eb9"),y(h,"class","geofence-list svelte-ov1eb9"),y(s,"class","content-container svelte-ov1eb9"),y(i,"class","app-container svelte-ov1eb9")},m(p,I){_(document.head,e),z(p,t,I),z(p,n,I),_(n,i),_(i,s),_(s,o),_(o,r),_(r,a),_(o,E),P.m(o,null),_(s,v),_(s,b),l[9](b),_(s,d),_(s,h),_(h,f),_(h,S),L.m(h,null)},p(p,I){I[0]&16&&te(a,p[4]),D===(D=U(p))&&P?P.p(p,I):(P.d(1),P=D(p),P&&(P.c(),P.m(o,null))),O===(O=F(p))&&L?L.p(p,I):(L.d(1),L=O(p),L&&(L.c(),L.m(h,null)))},i:H,o:H,d(p){p&&(g(t),g(n)),g(e),P.d(),l[9](null),L.d()}}}function Ee(l,e){let t=!1;for(let n=0,i=e.length-1;n<e.length;i=n++){const s=e[n].lat,o=e[n].lng,r=e[i].lat,a=e[i].lng;o>l.lng!=a>l.lng&&l.lat<(r-s)*(l.lng-o)/(a-o)+s&&(t=!t)}return t}function Ie(l,e,t){const i=l.lat*Math.PI/180,s=e.lat*Math.PI/180,o=(e.lat-l.lat)*Math.PI/180,r=(e.lng-l.lng)*Math.PI/180,a=Math.sin(o/2)*Math.sin(o/2)+Math.cos(i)*Math.cos(s)*Math.sin(r/2)*Math.sin(r/2);return 6371e3*(2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)))<=t}function Ce(l,e,t){delete N.Icon.Default.prototype._getIconUrl,N.Icon.Default.mergeOptions({iconRetinaUrl:"/leaflet/marker-icon-2x.png",iconUrl:"/leaflet/marker-icon.png",shadowUrl:"/leaflet/marker-shadow.png"});let n=null,i,s,o=null,r=new Map,a=null,E="",v="",b=[],d=!1,h=!1,f,T,S,U=null,D="default";const P=2*60*1e3,F=N.icon({iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function O(u){if(!u)return;const c=[],m=[];r.forEach((M,C)=>{let G=!1;M.type==="circle"?G=Ie(u,M.center,M.radius):(M.type==="polygon"||M.type==="rectangle")&&(G=Ee(u,M.coordinates)),G?(c.push(C),b.includes(C)||"Notification"in window&&D==="granted"&&new Notification("Geofence Alert",{body:`You have entered ${C}`,icon:"/vite.svg"})):(m.push(C),b.includes(C)&&"Notification"in window&&D==="granted"&&new Notification("Geofence Alert",{body:`You have left ${C}`,icon:"/vite.svg"}))}),b=c,b.length>0?t(4,v=`Inside geofence(s): ${b.join(", ")}`):t(4,v="Outside all geofences")}function L(){U||(U=window.setInterval(()=>{o&&O(o)},P))}function p(){U&&(window.clearInterval(U),U=null)}async function I(u){try{if(!n||!u||!u.coords)return;const{latitude:c,longitude:m,accuracy:M}=u.coords,C={lat:c,lng:m};o=C,T?T.setLatLng([c,m]):T=N.marker([c,m],{icon:F}).addTo(n),S?(S.setLatLng([c,m]),S.setRadius(M)):S=N.circle([c,m],{radius:M}).addTo(n),O(C)}catch(c){console.error("Error updating position:",c),t(4,v="Error updating position")}}async function K(){try{if(!i){console.error("Map element not found");return}n=N.map(i,{zoomControl:!0,keyboard:!0,minZoom:1,maxZoom:22,zoomDelta:.5,zoomSnap:.5}).setView([0,0],2),N.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:" OpenStreetMap contributors",maxNativeZoom:19,maxZoom:22}).addTo(n),s=new N.FeatureGroup,n.addLayer(s);const u=new N.Control.Draw({draw:{polyline:!1,circlemarker:!1,marker:!1,circle:!0,polygon:!0,rectangle:!0},edit:{featureGroup:s,remove:!0}});n.addControl(u),n.on("draw:created",c=>{const m=c.layer;s.addLayer(m);const M=c.layerType,C=Math.random().toString(36).substr(2,9),G=`Geofence ${r.size+1}`;let ee;if(M==="circle"){const X=m.getLatLng(),x=m.getRadius();ee={id:C,name:G,type:"circle",center:{lat:X.lat,lng:X.lng},radius:x,coordinates:[],layer:m}}else{const X=m.getLatLngs()[0].map(x=>({lat:x.lat,lng:x.lng}));ee={id:C,name:G,type:M,coordinates:X,center:{lat:0,lng:0},radius:0,layer:m}}r.set(G,ee),t(1,r)}),n.on("draw:deleted",c=>{c.layers.eachLayer(M=>{r.forEach((C,G)=>{C.layer===M&&r.delete(G)})}),t(1,r)}),"geolocation"in navigator?navigator.geolocation.getCurrentPosition(c=>{const{latitude:m,longitude:M}=c.coords;n&&(n.setView([m,M],13),I(c))},c=>{console.error("Error getting location:",c),t(4,v="Error getting location. Please enable location services.")}):t(4,v="Geolocation is not supported by your browser"),h=!0}catch(u){console.error("Error initializing map:",u),t(4,v="Error initializing map. Please refresh the page.")}}async function J(){d||(t(5,d=!0),"geolocation"in navigator?(f=navigator.geolocation.watchPosition(I,u=>{console.error("Error watching position:",u),t(4,v="Error watching position"),t(5,d=!1)},{enableHighAccuracy:!0,timeout:5e3,maximumAge:0}),L(),t(4,v="Monitoring location...")):t(4,v="Geolocation is not supported by your browser"))}async function V(){d&&f!==null&&(navigator.geolocation.clearWatch(f),p(),t(5,d=!1),t(4,v="Monitoring stopped"))}function j(u,c){if(r.has(u)&&!r.has(c)){const m=r.get(u);r.delete(u),r.set(c,{...m,name:c}),t(1,r),t(2,a=null)}}le(async()=>{if("serviceWorker"in navigator&&"permissions"in navigator)try{if(await Notification.requestPermission()==="granted"){const c=await navigator.serviceWorker.ready;if("periodicSync"in c)try{await c.periodicSync.register("check-geofence",{minInterval:15*60*1e3}),console.log("Periodic background sync registered")}catch(m){console.error("Error registering periodic sync:",m)}}}catch(u){console.error("Error setting up notifications:",u)}"Notification"in window&&(D=await Notification.requestPermission()),await K()}),ie(()=>{p(),f&&(navigator.geolocation.clearWatch(f),t(5,d=!1))});function Q(u){ae[u?"unshift":"push"](()=>{i=u,t(0,i)})}return[i,r,a,E,v,d,J,V,j,Q,u=>{const c=u.currentTarget;t(3,E=c.value)},(u,c)=>{c.key==="Enter"?j(u,E):c.key==="Escape"&&t(2,a=null)},(u,c)=>{t(2,a=u.id),t(3,E=c)}]}class Ne extends ue{constructor(e){super(),fe(this,e,Ce,Me,se,{},null,[-1,-1])}}export{Ne as component};

const r="svelte-pwa-v1",u="location-sync",h="periodic-geofence-check",p="GeofenceDB",a="locationUpdates",g=["/","/index.html","/manifest.json","/vite.svg","/assets/main-4xXvW1dQ.css","/assets/main-CJFkDncB.js","/assets/spritesheet-DpIxuf5L.svg"];function c(){return new Promise((t,o)=>{if(!indexedDB){o(new Error("IndexedDB is not supported in this context"));return}const e=indexedDB.open(p,1);e.onerror=()=>o(e.error),e.onsuccess=()=>t(e.result),e.onupgradeneeded=i=>{const n=i.target.result;n.objectStoreNames.contains(a)||n.createObjectStore(a,{keyPath:"timestamp"})}})}async function w(t){try{await(await c()).transaction(a,"readwrite").objectStore(a).add({timestamp:new Date().getTime(),location:t})}catch(o){console.warn("Failed to store location update:",o)}}async function d(){const e=(await c()).transaction(a,"readwrite").objectStore(a),i=await e.getAll();for(const n of i)try{(await self.clients.matchAll()).forEach(f=>{f.postMessage({type:"location-update",location:n})}),n.isInsideGeofence&&await l("Geofence Alert",{body:`You are inside the geofence: ${n.geofenceName}`,icon:"/vite.svg",badge:"/vite.svg",data:{location:n}}),await e.delete(n.timestamp)}catch(s){console.error("Error processing location:",s)}}async function l(t,o){try{await Notification.requestPermission()==="granted"&&await self.registration.showNotification(t,o)}catch(e){console.error("Error showing notification:",e)}}self.addEventListener("install",t=>{t.waitUntil(caches.open(r).then(o=>o.addAll(g)))});self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(o=>Promise.all(o.map(e=>{if(e!==r)return caches.delete(e)}))))});self.addEventListener("fetch",t=>{t.respondWith(caches.match(t.request).then(o=>{if(o)return o;if(t.request.method!=="GET")return fetch(t.request);const e=new URL(t.request.url);return e.origin!==location.origin&&!e.href.includes("tile.openstreetmap.org")?fetch(t.request):fetch(t.request.clone()).then(i=>{if(!i||i.status!==200)return i;if(e.origin===location.origin||e.href.includes("tile.openstreetmap.org")){const n=i.clone();caches.open(r).then(s=>{s.put(t.request,n)}).catch(s=>console.error("Cache put error:",s))}return i}).catch(i=>{if(console.error("Fetch error:",i),t.request.mode==="navigate")return caches.match("/");throw i})}))});self.addEventListener("sync",t=>{t.tag===u&&t.waitUntil(d())});self.addEventListener("periodicsync",t=>{t.tag===h&&t.waitUntil(d())});self.addEventListener("push",t=>{if(!t.data)return;const o=t.data.json();t.waitUntil(l(o.title,{body:o.body,icon:"/vite.svg",badge:"/vite.svg",data:o}))});self.addEventListener("notificationclick",t=>{t.notification.close(),t.waitUntil(clients.openWindow("/"))});self.addEventListener("message",t=>{t.data.type==="store-location"&&t.waitUntil(w(t.data.location))});
